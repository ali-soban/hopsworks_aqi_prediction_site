# .github/workflows/train_pipeline.yml

name: Daily Model Training Pipeline

# Controls when the workflow will run
on:
  schedule:
    # Runs "at minute 0 past hour 1" (e.g., 01:00 UTC) every day
    - cron: '0 1 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  train-model:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Install necessary Python packages
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas scikit-learn joblib

      # Runs the Python script for model training
      - name: Run training script
        id: run_script
        run: |
          # --- Python Script for Model Training ---
          import pandas as pd
          import numpy as np
          from sklearn.ensemble import ExtraTreesRegressor # Using the best model
          from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
          import joblib
          import warnings

          warnings.filterwarnings('ignore', category=UserWarning)

          print("--- MODEL TRAINING SCRIPT ---")

          input_file = 'latest_features.csv'
          model_output_file = 'aqi_model_extratrees.joblib' # Save the best model

          print(f"Loading data from {input_file}...")
          try:
              df = pd.read_csv(input_file, parse_dates=True, index_col='time')
              # Ensure the target column is present and drop rows where it's NaN (future points)
              if 'target_AQI' not in df.columns:
                   print("ERROR: target_AQI column not found in feature file.")
                   exit(1)
              df.dropna(subset=['target_AQI'], inplace=True)
              if df.empty:
                   print("ERROR: No valid training data after dropping NaN targets.")
                   exit(1)

          except FileNotFoundError:
              print(f"ERROR: {input_file} not found. Cannot train model.")
              exit(1)
          except Exception as e:
               print(f"ERROR: Could not load or process data file: {e}")
               exit(1)


          print(f"Data loaded: {df.shape[0]} rows.")

          # Define Features (X) and Target (y)
          TARGET_COLUMN = 'target_AQI'
          X = df.drop(columns=[TARGET_COLUMN])
          y = df[TARGET_COLUMN]

          # Ensure all feature columns expected are present (handle potential missing cols)
          expected_features = [
              'hour_sin', 'hour_cos', 'day_of_week_sin', 'day_of_week_cos', 'month_sin', 'month_cos',
              'temperature_2m', 'relative_humidity_2m', 'precipitation', 'wind_speed_10m', 'wind_direction_10m',
              'aqi_lag_1hr', 'aqi_lag_3hr', 'aqi_lag_24hr', 'aqi_lag_72hr',
              'temp_lag_1hr', 'humidity_lag_1hr', 'wind_speed_lag_1hr',
              'aqi_rolling_3hr', 'aqi_change_1hr'
          ]
          missing_cols = [col for col in expected_features if col not in X.columns]
          if missing_cols:
              print(f"WARNING: Missing expected feature columns: {missing_cols}. Adding them as NaN.")
              for col in missing_cols:
                  X[col] = np.nan

          # Drop rows with any NaN features before training (important!)
          original_len = len(X)
          X.dropna(inplace=True)
          y = y.loc[X.index] # Align target with features
          rows_dropped = original_len - len(X)
          if rows_dropped > 0:
               print(f"Dropped {rows_dropped} rows due to NaN feature values.")

          if X.empty or y.empty:
               print("ERROR: No data left after handling NaNs. Cannot train model.")
               exit(1)

          print(f"Training data shape: X={X.shape}, y={y.shape}")

          # Train Model (ExtraTreesRegressor)
          model = ExtraTreesRegressor(
              n_estimators=100,
              random_state=42,
              n_jobs=-1,
              max_depth=15,
              min_samples_leaf=5
          )

          print("\nTraining ExtraTreesRegressor model...")
          try:
              model.fit(X[expected_features], y) # Ensure columns are in expected order
              print("Model training complete.")
          except Exception as e:
               print(f"ERROR: Model training failed: {e}")
               exit(1)

          # Save the Trained Model
          try:
              joblib.dump(model, model_output_file)
              print(f"Model saved as '{model_output_file}'")
          except Exception as e:
              print(f"ERROR: Could not save model: {e}")
              exit(1)

          # (Optional) Evaluate on the training data itself or a held-out portion
          print("\nEvaluating model on training data (for reference)...")
          y_pred_train = model.predict(X[expected_features])
          rmse = np.sqrt(mean_squared_error(y, y_pred_train))
          mae = mean_absolute_error(y, y_pred_train)
          r2 = r2_score(y, y_pred_train)
          print(f"Training RMSE: {rmse:.4f}, MAE: {mae:.4f}, RÂ²: {r2:.4f}")

          print("\n--- TRAINING PIPELINE SCRIPT COMPLETED ---")


      # Commits the updated model file back to the repository
      - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add aqi_model_extratrees.joblib
          # Commit only if there are changes
          git diff --staged --quiet || git commit -m "Update trained AQI model via GitHub Actions"
          git push
