# This file must be saved in: .github/workflows/train_pipeline.yml
# This script runs daily to train a new model from the Feature Store
# and save it to the Model Registry.

name: Daily Model Training (from Hopsworks)

on:
  schedule:
    - cron: '0 1 * * *' # Runs at 01:00 UTC daily
  workflow_dispatch: # Allows you to run it manually

jobs:
  train-model:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Pin scikit-learn to ensure model consistency
          pip install pandas joblib "hopsworks[python]" scikit-learn==1.5.1

      - name: Run training script with Hopsworks
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT_NAME: ${{ secrets.HOPSWORKS_PROJECT_NAME }}
        run: |
          python - <<EOF
          import pandas as pd
          import numpy as np
          from sklearn.ensemble import ExtraTreesRegressor
          from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
          import joblib
          import warnings
          import os
          import hopsworks 

          warnings.filterwarnings('ignore', category=UserWarning)
          print("--- MODEL TRAINING SCRIPT (HOPSWORKS) ---")

          print("Connecting to Hopsworks...")
          try:
              project = hopsworks.login(
                  api_key_value=os.environ['HOPSWORKS_API_KEY'],
                  project="aqi_prediction_site"
              )
              fs = project.get_feature_store()
              print("Connected to Hopsworks Feature Store.")
          except Exception as e:
              print(f"ERROR: Could not connect to Hopsworks: {e}")
              exit(1)

          # --- CONFIGURATION ---
          FEATURE_GROUP_NAME = "karachi_aqi_features"
          FEATURE_GROUP_VERSION = 1
          MODEL_NAME_REGISTRY = "karachi_aqi_predictor" # This is the name your app will look for
          
          print(f"Loading data from Feature Group '{FEATURE_GROUP_NAME}' v{FEATURE_GROUP_VERSION}...")
          try:
              feature_group = fs.get_feature_group(
                  name=FEATURE_GROUP_NAME,
                  version=FEATURE_GROUP_VERSION
              )
              # Read all data from the feature group
              df = feature_group.read() 
              
              if df.empty:
                   print("ERROR: No data read from Feature Group.")
                   exit(1)
                   
              if 'event_time' in df.columns:
                   # Convert event_time (int) back to datetime index
                   df['time'] = pd.to_datetime(df['event_time'], unit='s', utc=True)
                   df.set_index('time', inplace=True)
                   df.sort_index(inplace=True)
              else:
                   print("ERROR: 'event_time' primary key not found.")
                   exit(1)

              # *** CHANGED TO LOWERCASE ***
              # This is our training data: all rows where the target is not null
              df_train = df.dropna(subset=['target_aqi'])
              
              if df_train.empty:
                   print("ERROR: No valid training data after dropping NaN targets.")
                   exit(1)

          except Exception as e:
              print(f"ERROR: Could not read from Hopsworks Feature Group: {e}")
              exit(1)

          print(f"Training Data loaded: {df_train.shape[0]} rows.")

          # --- PREPARE X and y ---
          # *** CHANGED TO LOWERCASE ***
          TARGET_COLUMN = 'target_aqi'
          expected_features = [
              'hour_sin', 'hour_cos', 'day_of_week_sin', 'day_of_week_cos', 'month_sin', 'month_cos',
              'temperature_2m', 'relative_humidity_2m', 'precipitation', 'wind_speed_10m', 'wind_direction_10m',
              'aqi_lag_1hr', 'aqi_lag_3hr', 'aqi_lag_24hr', 'aqi_lag_72hr',
              'temp_lag_1hr', 'humidity_lag_1hr', 'wind_speed_lag_1hr',
              'aqi_rolling_3hr', 'aqi_change_1hr'
          ]
          
          # Ensure all expected columns are present
          for col in expected_features:
              if col not in df_train.columns:
                  print(f"Warning: Expected feature {col} not in Feature Group. Adding as 0.")
                  df_train[col] = 0

          X = df_train[expected_features]
          y = df_train[TARGET_COLUMN]

          # Ensure no NaNs in training data (should be handled by FG dropna)
          X.fillna(0, inplace=True) # Fill any remaining NaNs with 0

          print(f"Training data shape: X={X.shape}, y={y.shape}")

          # --- TRAIN MODEL ---
          model = ExtraTreesRegressor(
              n_estimators=100, random_state=42, n_jobs=-1,
              max_depth=15, min_samples_leaf=5
          )

          print("\nTraining ExtraTreesRegressor model...")
          model.fit(X, y)
          print("Model training complete.")
          
          # Save model locally first
          local_model_file = 'aqi_model_extratrees.joblib'
          joblib.dump(model, local_model_file)
          print(f"Model saved locally as '{local_model_file}'")

          # --- EVALUATE AND SAVE TO REGISTRY ---
          print("\nEvaluating model on training data (for reference)...")
          y_pred_train = model.predict(X)
          rmse = np.sqrt(mean_squared_error(y, y_pred_train))
          mae = mean_absolute_error(y, y_pred_train)
          r2 = r2_score(y, y_pred_train)
          metrics = {"training_rmse": rmse, "training_mae": mae, "training_r2": r2}
          print(f"Metrics: {metrics}")

          print("\nSaving model to Hopsworks Model Registry...")
          try:
              mr = project.get_model_registry()
              
              # Create the schema (input/output) for the model
              from hsml.schema import Schema
              from hsml.model_schema import ModelSchema

              input_schema = Schema(X)
              output_schema = Schema(y)
              model_schema = ModelSchema(input_schema=input_schema, output_schema=output_schema)
              
              hopsworks_model = mr.sklearn.create_model(
                  name=MODEL_NAME_REGISTRY,
                  metrics=metrics,
                  description="AQI Predictor (ExtraTreesRegressor) trained via GitHub Actions",
                  input_example=X.sample(min(5, len(X))), 
                  model_schema=model_schema
              )
              
              # Save the model artifact to Hopsworks
              # Note: hopsworks_model.save() will save the file as 'model.joblib' by default
              hopsworks_model.save(local_model_file)
              
              print(f"Model successfully saved to Hopsworks Registry as '{MODEL_NAME_REGISTRY}' version {hopsworks_model.version}")
          except Exception as e:
              print(f"ERROR: Could not save model to Hopsworks Model Registry: {e}")

          print("\n--- TRAINING PIPELINE SCRIPT COMPLETED ---")
          EOF